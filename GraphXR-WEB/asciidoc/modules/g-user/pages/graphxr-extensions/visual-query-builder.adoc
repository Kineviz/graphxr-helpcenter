= Visual Query Builder

The Visual Query Builder extension lets you build no-code *_Cypher_* queries from within a GraphXR project. You connect visual blocks that represent category, relationship, and property values to form a graph pattern, automatically generate a Cypher query, and run it. Once you've run the query, you can use the *_In-Memory Search_* function to find and select patterns in the returned data. 

image::/v2_17/10_01_01_VQBMovie1320.png[]

NOTE: You can enter and run any Cypher query in GraphXR's *_Query_* panel. But with Visual Query Builder, you can start using Cypher's most useful graph pattern-matching functions right away, which lets you explore your graph data much more quickly and easily.

NOTE: To quickly connect Neo4j with GraphXR, https://neo4j.com/download/[download Neo4j Desktop] and https://neo4j.com/blog/graphxr-graph-app-neo4j-desktop/[follow the steps] to add GraphXR as a graph app onto Neo4j.

== Cypher and Pattern Matching

Cypher, developed by Neo4j, is a query language for selecting, presenting, and transforming graph data, and for managing a graph database.

=== Patterns Visual Query Builder can match

Visual Query Builder focuses on Cypher's capability to match patterns and return data as nodes and edges. This type of Cypher query is generally structured as follows:

[cols="5,3"]
|===
| Cypher | Description

| *MATCH* *(a:Category) - [b: RELATIONSHIP] \-> (c:Category) ...etc.*
| Match (i.e., find) specified graph patterns, usually based on category labels and relationship labels and directions. Multiple MATCH statements can be used to query for branched patterns. *_Note:_* Although you can specify property values in a MATCH statement, a *_WHERE_* clause is usually used.

| *WHERE* *a.PropertyName1 = Value AND ...etc.*
| Qualifiers based on property values in the specified nodes and edges. To match values, Visual Query Builder provides *_Equals_*, *_Greater Than_*, *_Less Than_*, *_Like_*, or *_In_* operators.

| *RETURN * LIMIT 25*
| Return matching nodes and edges, optionally limiting the number of nodes returned.
|===

NOTE: To learn and use additional Cypher capabilities such as specifying ranges of values, returning property data as tables or lists, merging or parsing data, creating new nodes and edges, and managing and tuning query performance, see Neo4j's free learning resources, including: https://neo4j.com/events/world/training/[Cypher Classroom training],  https://neo4j.com/graphacademy/online-training/introduction-to-neo4j-40/[Cypher Online training], and https://neo4j.com/sandbox/?ref=developer-cypher[Hands-on in Sandbox guides] (use command `:play cypher`)

=== From Visual Query to Cypher

A basic Cypher query on the Neo4j open source *_Movie_* database is shown below. It finds patterns where a _Person_  node whose _name_ property value includes "`Tom`" has _ACTED_IN_ a _Movie_, and returns the first 25 found: 

----
MATCH (a:Person)-[b:ACTED_IN]-(e:Movie) MATCH (a:Person)-[d:DIRECTED]-(e:Movie) WHERE a.name =~ ".Tom." RETURN * LIMIT 25
----

To build this query in Visual Query Builder, you use _Person_ and _Movie_ *_Category_* blocks and connect them through sockets to an _ACTED_IN_ *_Relationship_* block. You then specify the _name_ property by connecting a *_Property_* block to the _Person_  *_Category_* block through property sockets, as shown below:

image::/v2_17/10_01_03_VQBMovieCypherProps720.png[]

Once you've built a query, you can copy it to the clipboard, and paste it into GraphXR's *_Query_* panel and *_Cypher_* tab. This enables you to save, edit, and even extend your query by using additional Cypher functions not available in Visual Query Builder.

NOTE: Cypher query capabilities such as CREATE or MERGE are only available if the correct user privileges are set in Neo4j.

== Building Visual Queries

Visual Query Builder provides the workspace and building blocks to build and run a Cypher query (or In-Memory Search) for graph patterns based on categories, relationships, and their properties. You can:

* Build and run a Cypher query:
 ** Click a *_Category_*, *_Relationship_*, or *_Property_* building block to add it to the workspace, select its available specifications, and connect the building blocks using the provided sockets.
+
You can query for patterns in just one category of nodes, or one that links any number of categories and directed relationships.
 ** Click the *_Cypher Query_* block at any time to see the query being built. In its *_Limit_* field, you can edit the number of nodes to return. When the query is built, click its run arrow to run the query.
 ** Modify an existing query.
* Use *_In Memory Search_* to find and highlight subgraphs in the returned data.
* Export and import visual queries as JSON files.

image::/v2_17/10_01_04_VQBInterface1320.png[]

NOTE: We'll build visual queries on the Neo4j _Movies_ database available through the GraphXR demo project _VQB Movies_. It includes _Person_, _Movie_, and _Distributor_ categories, linked by relationships including _ACTED_IN_, _DIRECTED_, and  _REVIEWED_. To explore the project, log in, go to the *_Project>Data_* tab, and load a saved data view.

=== Build a query on a single Category

A simple pattern is one that looks for specific nodes of only one category. The following example shows a query for _Person_ nodes whose _name_ property includes "`Tom`".

*To build a visual query on a single category:*

. Log in to GraphXR, and click to open the _VQB Movies_ Demo project.
. In the *_Projects_* panel and *_Extensions_* tab select *_Visual Query Builder_* from the dropdown menu.
. Click the *_Cypher Query_* block to add it to the workspace and view the query as it's being built.
+

NOTE: You can add the *_Cypher Query_* block at any time.

+
. Click a *_Category_* block to add it to the workspace, click its settings icon, and select the _Person_ label. We'll query for a specific name, so click its _name_ property and click *_OK_*.
. Now click to add a *_Property_* block. We use it to specify the _name_ of a person   (e.g. "`Tom`"). Click and drag to connect its socket to the _name_ socket on the _Person_ block.
. On the *_Property_* block, select *_Like_* from the dropdown menu, and enter _Tom_.
. Click the run arrow on the *_Cypher Query_* block.
+
Four matching _Person_ nodes are returned to the project space.
+
image::/v2_17/10_01_05_VQBPersonOnly1320.png[]

=== Build a query on a multiple Categories, Relationships, and properties

A more complicated pattern can specify more than one category and their properties, as well as multiple relationships of interest. 

The following example shows a query for _Person_ nodes with a _name_ that includes "`Tom`", who _ACTED_IN_ a _Movie_ that was _released_ after 1990.

*To build a visual query for multiple category and relationship patterns:*

. Open Visual Query Builder. Click the *_Cypher Query_* block to add it to the workspace so that you can view the query as it's being built.
+

NOTE: You can add the *_Cypher Query_* block at any time.

. Click two category blocks and a relationship block to add them to the workspace.
. Click the settings icons on the category blocks and set them as follows:
* _Person_, with the _name_ property selected, then click *_OK_*. 
* _Movie_ , with the _released_ property selected, then click *_OK_*.
+
 
NOTE: If you are starting from the previous simple query, just add one more category block.

. Click the settings icon on the relationship block, and set it to _ACTED_IN_.
. Click and drag between the white sockets to connect the category and relationship blocks.
. Click to add two *_Property_* blocks, and click and drag to connect their property sockets as follows:
* To the _name_ socket on the _Person_ category block (if not already connected). Then select *_Like_* from the dropdown menu and enter _Tom_.
* To the _released_ socket on the _Movie_ category block. Then select *_Greater than_* from the dropdown menu, and enter _1990_.

. Click the run icon on the Cypher query block.
+
image::/v2_17/10_01_06_VQBPersonMovie1320.png[]

If the query does not load, or returns unexpected results, see <<troubleshooting-visual-queries,Troubleshooting>>.

== Saving and sharing a Visual Query

You can save and share a visual query by exporting (or importing) it as a .JSON file. When you re-enter a project after exiting, you can then re-load the visual query into Visual Query Builder. This also lets you share a visual query with another user.

image::/v2_17/10_01_17_SaveExport960.png[,420,380,role=text-left]

*_To save a visual query_*:

* Click the *_Export_* icon at the top of the building blocks list.
+
A .JSON file is exported to your system and appears in your browser's Downloads tab.

*_To import a visual query_*:

. Open the Visual Query Builder, and in the building blocks panel, click the *_Import_* icon at the top of the building blocks list.
. Navigate to the .JSON file (typically, in your Downloads), select it and click *_Open_* to import it to the workspace.

NOTE: You can click the document icon at the lower right of the *_Cypher Query_* block to copy the Cypher query to the clipboard. Unlike .JSON export, this copies the Cypher query but does not preserve the visual building blocks. This can still be useful if you want to edit or extend a query quickly in GraphXR. From the clipboard, you can paste the query (Ctrl+V)into GraphXR's *_Query>Cypher_* panel. Click the plus image:/add.png[(plus)] icon to save the query before you edit it further.

== Editing a Visual Query

Once you've built and run a visual query you can continue to add and connect more building blocks, or remove blocks by dragging them to the *_Trash_* can icon at the lower right. The query in the *_Cypher Query_* block is immediately updated.

image::/v2_17/10_01_07_VQBClearQuery960R.png[,420,380,role=text-left]

To delete an entire query and start over with an empty workspace, click the *_Clear_* icon located to the right of the *_Export_* icon at the top of the building blocks panel.

== Using In Memory Search

Once graph data have been returned to GraphXR, you can also find and select subgraphs. Simply build (or import) a visual query and use *_In Memory Search_*, instead of the *_Cypher Query_* block.  Subgraphs can be single nodes, as in this query for any Twitter user with a _screen_name_ like "`Jeff`"...

image::/v2_17/10_01_08_InMemoryJeffs720R.png[]

... or connected nodes, as in this query for influential users connected through a specific RETWEETED relationship:

image::/v2_17/10_01_09_InMemorySelectAll720R.png[]

NOTE: The nodes returned to the search list are labeled with the caption you set in the GraphXR *_Project>Category_* panel. This may be (but isn't necessarily) the property name you used in the query pattern. You can change the caption at any time.
 
*To run an In-Memory Search:*

. In this example a node for each county in the United States has been imported to the GraphXR project space. To query for the counties in a particular state, we first click the *_In-Memory Search_* block to add it to the workspace.
. Increase the value in the *_Limit_* field to return more than the default 5 subgraphs.
. Click the *run* arrow at the top right of the block.
+
A list of matching nodes is displayed.

. Click an item on the list to select the node or pattern in the graph space. Or, click *_Select All_* to select all the patterns on the list.
+
image::/v2_17/10_01_10_InMemoryCounties720R.png[]
+
With the data selected, other GraphXR functions can be used. For example, you can *_Tag_* a selection, or use *_Inverse_* to select and then temporarily *_Hide_* or *_Delete_* all the other data.

== Case Study: Visual Queries for Social Media Research

Example visual queries were built on Twitter data collected for Kineviz' _Elections 2020_ project. In addition to Twitter _Users_, this Neo4j database includes:

* _Tweets_ and the _Media_ tweeted. 
* _RETWEETED_ relationships were created between _Users_ for several months of the 2020 US election cycle. 
* Additional generated properties including _User_ properties such as gender, age, race, language used, and the probability that the user is a bot, as well as _Tweet_ properties such as flags for fake news and hate speech.

=== Query on Influential Twitter Users

This query is for influential Twitter users who are probably bots and who have retweeted to other influential users in a particular month.

* In the Neo4j graph data connection is through relationships of the form _RETWEETED_YYYY_MM_.
* Influential bot users are those with a _followers_count_ property value greater than 20,000 and a _boto_prob_ (i.e. calculated probability) of 0.90 or greater.
+
image::/v2_17/10_01_11_TwitterChain960R.png[]

=== Query for linkage between nodes

Since graph data is often used to model complex connections (for example between people or ideas, time series, or spatial patterns), it can be interesting focus on chains of connected nodes. We can query for such a pattern by setting a *_length_* in the settings of a *_Relationship_* block.

image::/v2_17/10_01_14_TwitterRelLengthSelector960R.png[,420,380,role=text-left]

The *_length_* setting provides a dropdown menu and text boxes for entering a number:

* *_equal_*. Enter a whole number. Returns nodes connected via up to that number of the specified edge. (e.g. enter '3' to return nodes with 1, 2, or 3 of the specified connections).
* *_greater than_*. Enter a whole number. Returns nodes with that number or greater of connections via the specified edge. (e.g. enter '3' to return nodes with 3 or more of the specified connections)
* *_between_* - Two text boxes appear. Enter the lower and higher number to return nodes with that range of the specified edges. (e.g. enter 2-5 to return nodes with 2, 3, 4, or 5 of the specified edge.)

On the Twitter data, we could query for _Users_ who retweeted to one another during September 2020 (i.e., with the relationship _RETWEETED_2020_09)_ and are 3 to 5 hops to other _Users_ via that relationship.

image::/v2_17/10_01_15_TwitterRelBetween960R.png[,420,380,role=text-left]

The Cypher query now includes the length in the MATCH statement as a property of the relationship, as follows: MATCH (a:User)-[b:RETWEETED_2020_09*3..5]\->(c:User)

image::/v2_17/10_01_16_TwitterRelQuery1080R.png[,720,380,role=text-left]

== Visual Query Builder Quick Reference

[cols="2,6"] 
|===
| *To...* | *Action*

| Add a block to the workspace.
| Click the block.

| Move a block.
| Click and drag.

| Connect a block.
| Click a socket and drag the line to another socket.

| Disconnect a block.
| Click the socket a line is connected TO, and drag the line off.

| Delete a block or query.
| Click and drag to the Trash can.

| Clear the workspace of all blocks and queries.
| Click the *_Clear_* (brush) icon at the upper left side of the block selector panel.

| Set a *_Category_* or *_Relationship_* label.
| Click the settings icon on the *_Category_* or *_Relationship_* block and select a label.

| Set a *_Relationship_* direction.
| Click the settings icon on a *_Relationship_* block, click the *_Advanced_* dropdown, then the *_Select Direction_* menu and select *_Right_*.

| Specify a *_Property_* value.
| Click the dropdown menu on the *_Property_* block to select an operator (*_Equals_*, *_Greater Than_*, *_Less Than_*, *_Like_*, or *_In_*) and enter the value in the text box.

| Run a visual Cypher query.
| Click the *run* arrow on the *_Cypher Query_* block.

| Run an In-Memory Search
| After running a visual query in the workspace, click the *_In-Memory Search_* block and its *run* arrow.

| Export a visual query.
| Click the *_Export_* icon at the top left of the block selector panel.

| Import a visual query.
| Click the *_Import_* icon at the top left of the block selector panel, navigate to the .JSON file and click to open.

| Zoom in or out on the workspace.
| Use the mouse wheel.

| Reposition the entire visual query.
| Click on the workspace and drag.

| Dismiss the block selector panel.
| Click the X icon at the upper right of the panel.

| Display Visual Query Builder as a split screen or a full screen.
| Click the *_Split Screen_* or *_Full Screen_* icon at the upper right of the *_Extensions_* panel. While building a query, you can click the split screen or full screen icons at any time to expand the workspace.

| Display Visual Query Builder in a separate window.
| Click the *_Airplane_* icon at the upper right of the *_Extensions_* panel. The query you are building will persist, and will also persist if you close the separate window and re-open Visual Query Builder in the *_Extensions_* panel.
|===

== Troubleshooting Visual Queries

=== Common Issues

[cols="4,6"]
|===
| *Issue* | *Possible Resolution*

| An error message indicates that a connection to the server was not established.
| Most likely, the Cypher query is not well-formed. Check that you've actually connected the blocks, entered valid property values, and that the query has a valid number for the LIMIT.

| The query loads but does not return any results.
| If a query does not return results, but you know that matching data exist in the database, verify that entries for property values are spelled correctly, and that you have chosen the correct *Property* operator:

• *Greater Than* and *Less Than* operators accept only numerical values +
• *Like* accepts text strings. +
• *Equals* and *In* accepts either text strings or numerical values. The values will be matched exactly. *Equals* accepts a single value. For *In*, you can enter a list of comma-separated values (no leading space, no quotes). Spaces after a comma are ignored (i.e. _right,left,up,down_ returns the same results as _right, left, up, down_).
|===

=== Visual Query Builder Limitations

While you can specify many patterns using Visual Query Builder, some Cypher pattern matching functionality is not currently implemented, including:

* OR syntax in MATCH or WHERE statements.
* The _path_ variable in a MATCH statement. It refers to an entire pattern, which lets you refer to a complex set of connections as a single entity, and then apply property specifications to filter only those paths that qualify.
* Ranges of values in a WHERE statement (for example: a.property > 100 < 1000). Currently there is one socket for each property value, for which one operator can be selected.